---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const movies = (await getCollection('movies')).filter(m => !m.data.draft);
const shows = (await getCollection('shows')).filter(s => !s.data.draft);
const anime = (await getCollection('anime')).filter(a => !a.data.draft);

const queryParam = Astro.url.searchParams.get('q') || '';

const searchData = [
  ...movies.map(m => ({
    type: 'movie',
    id: m.data.id,
    title: m.data.title,
    year: m.data.year,
    thumbnail: m.data.thumbnail,
    description: m.data.description,
    tags: m.data.tags
  })),
  ...shows.map(s => ({
    type: 'show',
    tv: s.data.tv,
    title: s.data.title,
    year: s.data.year,
    thumbnail: s.data.thumbnail,
    description: s.data.description,
    tags: s.data.tags
  })),
  ...anime.map(a => ({
    type: 'anime',
    tv: a.data.tv,
    title: a.data.title,
    year: a.data.year,
    thumbnail: a.data.thumbnail,
    description: a.data.description,
    tags: a.data.tags
  }))
];
---

<Layout title="بحث - Stream">
  <div class="container-custom py-12">
    <h1 class="text-3xl md:text-4xl font-bold mb-8 text-white">البحث</h1>

    <div class="mb-8">
      <form action="/search" method="get" role="search">
        <div class="relative">
          <span class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 i-carbon-search text-xl"></span>
          <input
            type="search"
            name="q"
            id="search-input"
            value={queryParam}
            placeholder="ابحث عن أفلام، مسلسلات، أو أنمي..."
            class="w-full px-4 py-3 pr-12 rounded-lg border border-gray-700 bg-gray-800 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent"
            autocomplete="off"
            aria-label="بحث عن أفلام ومسلسلات وأنمي"
          />
        </div>
      </form>
    </div>

    <div id="search-results" class="mt-8">
      <p class="text-gray-400 text-center py-12">
        ابدأ الكتابة للبحث...
      </p>
    </div>
  </div>

  <script define:vars={{ searchData, queryParam }}>
    window.__SEARCH_DATA__ = searchData;
    window.__INITIAL_QUERY__ = queryParam;
  </script>
</Layout>

<script>
  import Fuse from 'fuse.js';

  interface SearchItem {
    type: 'movie' | 'show' | 'anime';
    id?: number;
    tv?: number;
    title: string;
    year: number;
    thumbnail: string;
    description: string;
    tags: string;
  }

  let fuse: Fuse<SearchItem>;

  function initSearch() {
    const searchData = (window as any).__SEARCH_DATA__ as SearchItem[];

    fuse = new Fuse(searchData, {
      keys: ['title', 'description', 'tags'],
      threshold: 0.3,
      includeScore: true,
    });
  }

  function renderResults(results: Fuse.FuseResult<SearchItem>[]) {
    const container = document.getElementById('search-results');
    if (!container) return;

    if (results.length === 0) {
      container.innerHTML = '<p class="text-gray-400 text-center py-12">لا توجد نتائج</p>';
      return;
    }

    const movieResults = results.filter(r => r.item.type === 'movie');
    const showResults = results.filter(r => r.item.type === 'show');
    const animeResults = results.filter(r => r.item.type === 'anime');

    let html = '';

    if (movieResults.length > 0) {
      html += '<div class="mb-12"><h2 class="text-2xl font-bold mb-6 text-white">أفلام</h2><div class="grid-responsive">';
      movieResults.forEach(result => {
        const item = result.item;
        const escapedTitle = item.title.replace(/"/g, '&quot;');
        html += `
          <a href="/movies/${item.id}" class="card group" aria-label="شاهد فيلم ${escapedTitle}">
            <div class="relative overflow-hidden rounded-lg">
              <img src="${item.thumbnail}" alt="${escapedTitle}" class="w-full h-[200px] object-cover group-hover:scale-110 transition-transform duration-300" loading="lazy" width="180" height="200" />
            </div>
            <div class="p-3 bg-gray-800">
              <h3 class="font-semibold text-sm mb-1 text-gray-100">${item.title}</h3>
              <p class="text-xs text-gray-400">${item.year}</p>
            </div>
          </a>
        `;
      });
      html += '</div></div>';
    }

    if (showResults.length > 0) {
      html += '<div class="mb-12"><h2 class="text-2xl font-bold mb-6 text-white">مسلسلات</h2><div class="grid-responsive">';
      showResults.forEach(result => {
        const item = result.item;
        const escapedTitle = item.title.replace(/"/g, '&quot;');
        html += `
          <a href="/shows/${item.tv}" class="card group" aria-label="شاهد مسلسل ${escapedTitle}">
            <div class="relative overflow-hidden rounded-lg">
              <img src="${item.thumbnail}" alt="${escapedTitle}" class="w-full h-[200px] object-cover group-hover:scale-110 transition-transform duration-300" loading="lazy" width="180" height="200" />
            </div>
            <div class="p-3 bg-gray-800">
              <h3 class="font-semibold text-sm mb-1 text-gray-100">${item.title}</h3>
              <p class="text-xs text-gray-400">${item.year}</p>
            </div>
          </a>
        `;
      });
      html += '</div></div>';
    }

    if (animeResults.length > 0) {
      html += '<div class="mb-12"><h2 class="text-2xl font-bold mb-6 text-white">أنمي</h2><div class="grid-responsive">';
      animeResults.forEach(result => {
        const item = result.item;
        const escapedTitle = item.title.replace(/"/g, '&quot;');
        html += `
          <a href="/anime/${item.tv}" class="card group" aria-label="شاهد أنمي ${escapedTitle}">
            <div class="relative overflow-hidden rounded-lg">
              <img src="${item.thumbnail}" alt="${escapedTitle}" class="w-full h-[200px] object-cover group-hover:scale-110 transition-transform duration-300" loading="lazy" width="180" height="200" />
            </div>
            <div class="p-3 bg-gray-800">
              <h3 class="font-semibold text-sm mb-1 text-gray-100">${item.title}</h3>
              <p class="text-xs text-gray-400">${item.year}</p>
            </div>
          </a>
        `;
      });
      html += '</div></div>';
    }

    container.innerHTML = html;
  }

  document.addEventListener('DOMContentLoaded', () => {
    initSearch();

    const initialQuery = (window as any).__INITIAL_QUERY__;
    if (initialQuery && fuse) {
      const results = fuse.search(initialQuery);
      renderResults(results);
    }

    const searchInput = document.getElementById('search-input') as HTMLInputElement;
    if (searchInput) {
      searchInput.addEventListener('input', (e) => {
        const query = (e.target as HTMLInputElement).value.trim();

        if (!query) {
          const container = document.getElementById('search-results');
          if (container) {
            container.innerHTML = '<p class="text-gray-400 text-center py-12">ابدأ الكتابة للبحث...</p>';
          }
          return;
        }

        if (fuse) {
          const results = fuse.search(query);
          renderResults(results);
        }
      });
    }
  });
</script>
