---
import Layout from '../../layouts/Layout.astro';
import ShowCard from '../../components/ShowCard.astro';
import EpisodeCard from '../../components/EpisodeCard.astro';
import { getCollection } from 'astro:content';

export async function getStaticPaths() {
  const shows = await getCollection('shows');
  return shows
    .filter(s => !s.data.draft)
    .map(show => ({
      params: { tv: show.data.tv.toString() },
      props: { show },
    }));
}

const { show } = Astro.props;
const tvId = show.data.tv;

const allSeasons = (await getCollection('seasons'))
  .filter(s => !s.data.draft && s.data.tv === tvId)
  .sort((a, b) => a.data.se - b.data.se);

const allEpisodes = (await getCollection('episodes'))
  .filter(e => !e.data.draft && e.data.tv === tvId);

const allShows = (await getCollection('shows')).filter(s => !s.data.draft && s.data.tv !== tvId);
const relatedShows = allShows.slice(0, 6);

const tags = show.data.tags.split(',').map((t: string) => t.trim());
---

<Layout title={`${show.data.title} - Stream`} description={show.data.description}>
  <div class="container-custom py-12">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <div class="lg:col-span-2">
        <h1 class="text-3xl md:text-4xl font-bold mb-4">{show.data.title}</h1>

        <div class="flex flex-wrap gap-4 mb-6 text-sm text-gray-600 dark:text-gray-400">
          <div class="flex items-center gap-2">
            <span class="i-carbon-calendar"></span>
            <span>{show.data.year}</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="i-carbon-list"></span>
            <span>{allSeasons.length} مواسم</span>
          </div>
        </div>

        <div class="flex flex-wrap gap-2 mb-6">
          {tags.map((tag: string) => (
            <span class="px-3 py-1 bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300 rounded-full text-sm">
              {tag}
            </span>
          ))}
        </div>

        <div class="prose dark:prose-invert max-w-none mb-8">
          <h2 class="text-xl font-semibold mb-3">نبذة عن المسلسل</h2>
          <p class="text-gray-700 dark:text-gray-300 leading-relaxed">
            {show.data.description}
          </p>
        </div>

        <div class="mt-12">
          <h2 class="text-2xl font-bold mb-6">المواسم والحلقات</h2>
          {allSeasons.length === 0 ? (
            <p class="text-gray-500">لا توجد مواسم متاحة حالياً</p>
          ) : (
            <div class="space-y-8">
              {allSeasons.map(season => {
                const seasonEpisodes = allEpisodes
                  .filter(e => e.data.se === season.data.se)
                  .sort((a, b) => a.data.ep - b.data.ep);

                return (
                  <div class="bg-white dark:bg-gray-800 rounded-lg p-6">
                    <h3 class="text-xl font-semibold mb-4">الموسم {season.data.se}</h3>
                    {seasonEpisodes.length === 0 ? (
                      <p class="text-gray-500">لا توجد حلقات متاحة</p>
                    ) : (
                      <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
                        {seasonEpisodes.map(episode => (
                          <EpisodeCard
                            tv={episode.data.tv}
                            se={episode.data.se}
                            ep={episode.data.ep}
                            title={episode.data.title}
                            duration={episode.data.duration}
                          />
                        ))}
                      </div>
                    )}
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </div>

      <div>
        <img
          src={show.data.thumbnail}
          alt={show.data.title}
          class="w-full rounded-lg shadow-lg mb-6"
          loading="lazy"
        />

        {relatedShows.length > 0 && (
          <div class="mt-8">
            <h3 class="text-xl font-semibold mb-4">مسلسلات مقترحة</h3>
            <div class="space-y-4">
              {relatedShows.map(relatedShow => (
                <ShowCard
                  tv={relatedShow.data.tv}
                  title={relatedShow.data.title}
                  year={relatedShow.data.year}
                  thumbnail={relatedShow.data.thumbnail}
                />
              ))}
            </div>
          </div>
        )}
      </div>
    </div>
  </div>
</Layout>
